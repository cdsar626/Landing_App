---
import { countries } from "../utils/countries.js";
---

<section id="waitlist" class="waitlist-section">
  <div class="container">
    <div class="form-wrapper glass-panel">
      <div class="text-content">
        <h2 data-i18n="waitlist.title">
          Join the <span class="gradient-text">Exclusive Beta</span>
        </h2>
        <p data-i18n="waitlist.desc">
          Be among the first to experience it. Founding users will receive an
          exclusive item for their Avatar.
        </p>
      </div>

      <form class="signup-form" id="waitlist-form">
        <div class="input-group">
          <input
            type="email"
            data-i18n-placeholder="waitlist.email"
            placeholder="Your email address"
            required
            class="input-field"
          />
        </div>

        <!-- Custom Country Selector -->
        <div
          class="input-group custom-select-container"
          id="country-custom-container"
        >
          <div class="custom-select-trigger" id="country-trigger">
            <span id="country-trigger-text" data-i18n="waitlist.select_country"
              >Select a country</span
            >
            <div class="arrow"></div>
          </div>
          <div class="custom-options" id="country-options">
            <!-- Populated by JS -->
          </div>
          <input type="hidden" id="country-value" name="country" required />
        </div>

        <!-- Custom State Selector -->
        <div
          id="state-group"
          class="input-group custom-select-container"
          style="display: none;"
        >
          <div class="custom-select-trigger" id="state-trigger">
            <span id="state-trigger-text" data-i18n="waitlist.select_state"
              >Select a state</span
            >
            <div class="arrow"></div>
          </div>
          <div class="custom-options" id="state-options">
            <div class="custom-option" data-value="AL">Alabama</div>
            <div class="custom-option" data-value="AK">Alaska</div>
            <div class="custom-option" data-value="AZ">Arizona</div>
            <div class="custom-option" data-value="AR">Arkansas</div>
            <div class="custom-option" data-value="CA">California</div>
            <div class="custom-option" data-value="CO">Colorado</div>
            <div class="custom-option" data-value="CT">Connecticut</div>
            <div class="custom-option" data-value="DE">Delaware</div>
            <div class="custom-option" data-value="FL">Florida</div>
            <div class="custom-option" data-value="GA">Georgia</div>
            <div class="custom-option" data-value="HI">Hawaii</div>
            <div class="custom-option" data-value="ID">Idaho</div>
            <div class="custom-option" data-value="IL">Illinois</div>
            <div class="custom-option" data-value="IN">Indiana</div>
            <div class="custom-option" data-value="IA">Iowa</div>
            <div class="custom-option" data-value="KS">Kansas</div>
            <div class="custom-option" data-value="KY">Kentucky</div>
            <div class="custom-option" data-value="LA">Louisiana</div>
            <div class="custom-option" data-value="ME">Maine</div>
            <div class="custom-option" data-value="MD">Maryland</div>
            <div class="custom-option" data-value="MA">Massachusetts</div>
            <div class="custom-option" data-value="MI">Michigan</div>
            <div class="custom-option" data-value="MN">Minnesota</div>
            <div class="custom-option" data-value="MS">Mississippi</div>
            <div class="custom-option" data-value="MO">Missouri</div>
            <div class="custom-option" data-value="MT">Montana</div>
            <div class="custom-option" data-value="NE">Nebraska</div>
            <div class="custom-option" data-value="NV">Nevada</div>
            <div class="custom-option" data-value="NH">New Hampshire</div>
            <div class="custom-option" data-value="NJ">New Jersey</div>
            <div class="custom-option" data-value="NM">New Mexico</div>
            <div class="custom-option" data-value="NY">New York</div>
            <div class="custom-option" data-value="NC">North Carolina</div>
            <div class="custom-option" data-value="ND">North Dakota</div>
            <div class="custom-option" data-value="OH">Ohio</div>
            <div class="custom-option" data-value="OK">Oklahoma</div>
            <div class="custom-option" data-value="OR">Oregon</div>
            <div class="custom-option" data-value="PA">Pennsylvania</div>
            <div class="custom-option" data-value="RI">Rhode Island</div>
            <div class="custom-option" data-value="SC">South Carolina</div>
            <div class="custom-option" data-value="SD">South Dakota</div>
            <div class="custom-option" data-value="TN">Tennessee</div>
            <div class="custom-option" data-value="TX">Texas</div>
            <div class="custom-option" data-value="UT">Utah</div>
            <div class="custom-option" data-value="VT">Vermont</div>
            <div class="custom-option" data-value="VA">Virginia</div>
            <div class="custom-option" data-value="WA">Washington</div>
            <div class="custom-option" data-value="WV">West Virginia</div>
            <div class="custom-option" data-value="WI">Wisconsin</div>
            <div class="custom-option" data-value="WY">Wyoming</div>
          </div>
          <input type="hidden" id="state-value" name="state" />
        </div>

        <button
          type="submit"
          class="btn-primary submit-btn"
          data-i18n="waitlist.btn"
        >
          Sign Me Up
        </button>
      </form>

      <p class="privacy-note" data-i18n="waitlist.note">
        No spam. Only important updates.
      </p>
    </div>
  </div>
</section>

<script>
  // @ts-nocheck
  import { countries } from "../utils/countries.js";
  import { translations } from "../utils/i18n.js";

  // --- Utility: Get localized string ---
  function t(key) {
    const lang = localStorage.getItem("preferred-lang") || "en";
    return translations[lang][key] || key;
  }

  // --- Logic for Country Selector ---
  const countryTrigger = document.getElementById("country-trigger");
  const countryOptions = document.getElementById("country-options");
  const countryValue = document.getElementById("country-value");
  const countryTriggerText = document.getElementById("country-trigger-text");

  const stateGroup = document.getElementById("state-group");
  const stateTrigger = document.getElementById("state-trigger");
  const stateOptions = document.getElementById("state-options");
  const stateValue = document.getElementById("state-value");
  const stateTriggerText = document.getElementById("state-trigger-text");

  // Toggle dropdowns
  countryTrigger.addEventListener("click", (e) => {
    e.stopPropagation();
    countryOptions.classList.toggle("open");
    stateOptions.classList.remove("open");
  });

  stateTrigger.addEventListener("click", (e) => {
    e.stopPropagation();
    stateOptions.classList.toggle("open");
    countryOptions.classList.remove("open");
  });

  // Close when clicking outside
  document.addEventListener("click", () => {
    countryOptions.classList.remove("open");
    stateOptions.classList.remove("open");
  });

  function populateCountryOptions() {
    const lang = localStorage.getItem("preferred-lang") || "en";
    const topCodes = ["US", "MX", "ES"];
    const sortedTop = [
      countries.find((c) => c.code === "US"),
      countries.find((c) => c.code === "MX"),
      countries.find((c) => c.code === "ES"),
    ];
    const otherList = countries
      .filter((c) => !topCodes.includes(c.code))
      .sort((a, b) => a[lang].localeCompare(b[lang]));

    countryOptions.innerHTML = "";

    // Add "Select Country" as internal option too if desired, or skip
    sortedTop.forEach((country) => {
      const opt = document.createElement("div");
      opt.className =
        "custom-option" +
        (countryValue.value === country.code ? " selected" : "");
      opt.textContent = country[lang];
      opt.addEventListener("click", () => selectCountry(country, lang));
      countryOptions.appendChild(opt);
    });

    // --- ADD SEPARATOR ---
    const separator = document.createElement("div");
    separator.className = "custom-separator";
    countryOptions.appendChild(separator);

    otherList.forEach((country) => {
      const opt = document.createElement("div");
      opt.className =
        "custom-option" +
        (countryValue.value === country.code ? " selected" : "");
      opt.textContent = country[lang];
      opt.addEventListener("click", () => selectCountry(country, lang));
      countryOptions.appendChild(opt);
    });

    // --- UPDATE CURRENTLY SELECTED TEXT ---
    if (countryValue.value) {
      const selected = countries.find((c) => c.code === countryValue.value);
      if (selected) {
        countryTriggerText.textContent = selected[lang];
      }
    }
  }

  function selectCountry(country, lang) {
    const countryValue = document.getElementById("country-value");
    const countryTriggerText = document.getElementById("country-trigger-text");
    const stateGroup = document.getElementById("state-group");
    const stateValue = document.getElementById("state-value");
    const stateTriggerText = document.getElementById("state-trigger-text");
    const countryOptions = document.getElementById("country-options");

    countryValue.value = country.code;
    countryTriggerText.textContent = country[lang];
    countryTriggerText.removeAttribute("data-i18n");

    if (country.code === "US") {
      stateGroup.style.display = "block";
      stateValue.setAttribute("required", "true");
    } else {
      stateGroup.style.display = "none";
      stateValue.removeAttribute("required");
      stateValue.value = "";
      stateTriggerText.textContent = t("waitlist.select_state");
    }
    countryOptions.classList.remove("open");
  }

  // Handle existing state options
  stateOptions.querySelectorAll(".custom-option").forEach((opt) => {
    opt.addEventListener("click", () => {
      stateValue.value = opt.getAttribute("data-value");
      stateTriggerText.textContent = opt.textContent;
      stateOptions.classList.remove("open");
    });
  });

  // Re-run on language change
  window.addEventListener("languageChanged", () => {
    populateCountryOptions();
    if (!countryValue.value)
      countryTriggerText.textContent = t("waitlist.select_country");
    if (!stateValue.value)
      stateTriggerText.textContent = t("waitlist.select_state");
  });

  document.addEventListener("DOMContentLoaded", populateCountryOptions);

  // Click on flags
  document.addEventListener("click", (e) => {
    if (e.target.closest(".lang-btn")) {
      setTimeout(() => {
        populateCountryOptions();
        if (!countryValue.value)
          countryTriggerText.textContent = t("waitlist.select_country");
        if (!stateValue.value)
          stateTriggerText.textContent = t("waitlist.select_state");
      }, 50);
    }
  });

  // --- Form Submission Logic ---
  const form = document.getElementById("waitlist-form");
  const submitBtn = form?.querySelector(".submit-btn");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const emailInput = form.querySelector('input[type="email"]');
      const email = emailInput.value;
      const country = countryValue.value;
      const state = stateValue.value;

      if (!email || !country) {
        // Simple validation check, though HTML 'required' handles most
        return;
      }

      // Visual Feedback
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Processing...";

      try {
        const res = await fetch("/api/join-waitlist", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, country, state: state || null }),
        });

        if (res.ok) {
          alert("Success! Check your email for confirmation.");
          form.reset();
          // Reset custom inputs visual state
          countryValue.value = "";
          stateValue.value = "";
          countryTriggerText.textContent = t("waitlist.select_country");
          stateTriggerText.textContent = t("waitlist.select_state");
          stateGroup.style.display = "none";
        } else {
          const data = await res.json();
          alert("Something went wrong: " + (data.error || "Unknown error"));
        }
      } catch (error) {
        console.error("Submission error:", error);
        alert("Network error. Please try again.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });
  }
</script>

<style is:global>
  .waitlist-section {
    padding: var(--section-spacing) 0;
    display: flex;
    justify-content: center;
  }

  .form-wrapper {
    max-width: 500px;
    width: 100%;
    margin: 0 auto;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 60px rgba(139, 92, 246, 0.25);
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
  }

  .signup-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .input-field {
    width: 100%;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-sm);
    color: white;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .input-field:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.25);
    border-color: white;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
  }

  .input-field::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  /* CUSTOM SELECT STYLES */
  .custom-select-container {
    position: relative;
    text-align: left;
    user-select: none; /* Disable text selection */
  }

  .custom-select-trigger {
    padding: 1rem;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-sm);
    color: white;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color 0.2s;
  }

  .custom-select-trigger:hover {
    border-color: var(--color-primary);
  }

  .arrow {
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid white;
    margin-left: 10px;
  }

  .custom-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0 0 8px 8px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 500;
    display: none;
    box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
    color: #333;
  }

  .custom-options.open {
    display: block;
  }

  .custom-option {
    padding: 0.8rem 1rem;
    cursor: pointer;
    color: #4b5563; /* Dark gray text */
    font-size: 0.95rem;
    transition: all 0.15s ease;
    border-left: 4px solid transparent;
  }

  .custom-option:hover {
    background-color: rgba(139, 92, 246, 0.1); /* Light purple tint */
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    padding-left: 1.25rem;
  }

  .custom-option.selected {
    background: rgba(139, 92, 246, 0.15);
    color: var(--color-primary);
    font-weight: 600;
    border-left-color: var(--color-primary);
  }

  .custom-separator {
    height: 1px;
    background: rgba(0, 0, 0, 0.1);
    margin: 0.5rem 1rem;
    pointer-events: none;
  }

  /* Scrollbar for options */
  .custom-options::-webkit-scrollbar {
    width: 6px;
  }
  .custom-options::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.3);
    border-radius: 10px;
  }

  .submit-btn {
    width: 100%;
    font-size: 1.1rem;
    margin-top: 1rem;
  }

  .privacy-note {
    margin-top: 1.5rem;
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }
</style>
